<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zyra - 社交平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .post-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .verified-badge {
            background-color: #f59e0b;
            color: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 2px white;
        }
        .user-link {
            cursor: pointer;
            color: #4f46e5;
        }
        .user-link:hover {
            text-decoration: underline;
        }
        .modal {
            background: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-width: 400px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
        <!-- 導航列 -->
        <nav class="bg-white shadow p-4 fixed top-0 left-0 right-0 z-50">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <a href="/Zyra/" class="text-2xl font-bold text-gray-800">Zyra</a>
                <div id="nav-buttons" class="space-x-4">
                    <button id="login-nav-btn" class="text-indigo-600 hover:text-indigo-800">登入</button>
                    <button id="register-nav-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">註冊</button>
                </div>
                <div id="user-info" class="hidden relative">
                    <div class="flex items-center space-x-3">
                        <div id="nav-avatar" class="h-10 w-10 rounded-full overflow-hidden flex items-center justify-center bg-indigo-100">
                            <span id="nav-avatar-text" class="text-indigo-800 font-bold"></span>
                            <img id="nav-avatar-img" class="h-full w-full object-cover hidden" alt="用戶頭像">
                        </div>
                        <span id="username-display" class="font-medium text-gray-800 user-link" onclick="goToProfile(currentUser.username)"></span>
                        <button id="settings-btn" class="text-gray-600 hover:text-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                    <div id="settings-dropdown" class="dropdown-content absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg p-2 hidden">
                        <button id="profile-btn" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">個人資料</button>
                        <button id="admin-panel-btn" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 hidden">管理員面板</button>
                        <button id="logout-btn" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主內容 -->
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-20">
            <!-- 發文區域 -->
            <div id="post-section" class="bg-white rounded-lg shadow-sm p-6 mb-8 hidden">
                <textarea id="post-content" class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-1 focus:ring-indigo-500 resize-none" rows="4" placeholder="分享你的想法..."></textarea>
                <div class="flex justify-end mt-4">
                    <button id="post-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">發布</button>
                </div>
            </div>

            <!-- 貼文列表 -->
            <div id="posts-container" class="space-y-6">
                <div id="loading-posts" class="text-center py-8">
                    <p class="text-gray-600">正在加載貼文...</p>
                </div>
            </div>
        </div>

        <!-- 登入模態框 -->
        <div id="login-modal" class="fixed inset-0 modal flex items-center justify-center hidden">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md relative z-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">登入</h2>
                <input id="login-identifier" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="使用者名稱或電子郵件">
                <input id="login-password" type="password" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="密碼">
                <button id="login-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">登入</button>
                <p class="mt-4 text-center text-gray-600">還沒有帳號？ <button id="to-register-btn" class="text-indigo-600 hover:underline">註冊</button></p>
                <button class="close-modal absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        </div>

        <!-- 註冊模態框 -->
        <div id="register-modal" class="fixed inset-0 modal flex items-center justify-center hidden">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md relative z-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">註冊</h2>
                <input id="register-displayname" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="暱稱（顯示名稱）">
                <input id="register-username" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="使用者名稱（僅限英文和數字）">
                <input id="register-about" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="關於我（選填）">
                <input id="register-password" type="password" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="密碼（6個字符以上，包含英文和數字）">
                <p id="password-error" class="text-red-500 text-sm hidden">密碼必須為6個字符以上，包含英文和數字</p>
                <p id="username-error" class="text-red-500 text-sm hidden">使用者名稱只能包含英文和數字</p>
                <button id="register-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">註冊</button>
                <p class="mt-4 text-center text-gray-600">已有帳號？ <button id="to-login-btn" class="text-indigo-600 hover:underline">登入</button></p>
                <button class="close-modal absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        </div>

        <!-- 個人資料模態框 -->
        <div id="profile-modal" class="fixed inset-0 modal flex items-center justify-center hidden">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md relative z-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">編輯個人資料</h2>
                <input id="update-displayname" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="新暱稱">
                <input id="update-username" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="新使用者名稱（僅限英文和數字）">
                <input id="update-about" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="關於我（選填）">
                <input id="update-email" type="email" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="電子郵件（選填）">
                <p id="update-username-error" class="text-red-500 text-sm hidden">新使用者名稱只能包含英文和數字</p>
                <button id="update-profile-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">更新資料</button>
                <button class="close-modal absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        </div>

        <!-- 管理員面板模態框 -->
        <div id="admin-panel-modal" class="fixed inset-0 modal flex items-center justify-center hidden">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-md relative z-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">管理員面板</h2>
                <input id="ban-username" type="text" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="要禁制的用戶名稱">
                <input id="ban-days" type="number" min="1" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="禁制天數">
                <button id="ban-user-btn" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">禁制用戶</button>
                <button class="close-modal absolute top-2 right-2 text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
        </div>

        <!-- 刪除確認對話框 -->
        <div id="delete-confirm-dialog" class="fixed inset-0 modal flex items-center justify-center hidden">
            <div class="modal-content bg-white rounded-lg p-6 w-full max-w-sm relative z-10">
                <h2 id="delete-confirm-title" class="text-xl font-bold text-gray-800 mb-4">確定要刪除這篇貼文嗎？</h2>
                <div class="flex justify-end space-x-4">
                    <button id="cancel-delete-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">確認</button>
                </div>
            </div>
            <div class="dialog-overlay absolute inset-0 bg-black opacity-50"></div>
        </div>
    </div>

    <script>
        // 初始化 Socket.IO
        const socket = io('https://zyra-backend-9317.onrender.com');

        // 當前用戶
        let currentUser = null;
        let currentDeletePostId = null;
        let currentDeleteComment = null;

        // DOM 元素
        const postSection = document.getElementById('post-section');
        const postContent = document.getElementById('post-content');
        const postBtn = document.getElementById('post-btn');
        const postsContainer = document.getElementById('posts-container');
        const loadingPosts = document.getElementById('loading-posts');
        const navButtons = document.getElementById('nav-buttons');
        const userInfo = document.getElementById('user-info');
        const usernameDisplay = document.getElementById('username-display');
        const navAvatarText = document.getElementById('nav-avatar-text');
        const navAvatarImg = document.getElementById('nav-avatar-img');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsDropdown = document.getElementById('settings-dropdown');
        const profileBtn = document.getElementById('profile-btn');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');
        const profileModal = document.getElementById('profile-modal');
        const adminPanelModal = document.getElementById('admin-panel-modal');
        const deleteConfirmDialog = document.getElementById('delete-confirm-dialog');
        const deleteConfirmTitle = document.getElementById('delete-confirm-title');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const banUserBtn = document.getElementById('ban-user-btn');
        const banUsernameInput = document.getElementById('ban-username');
        const banDaysInput = document.getElementById('ban-days');
        const passwordError = document.getElementById('password-error');
        const usernameError = document.getElementById('username-error');
        const updateUsernameError = document.getElementById('update-username-error');

        // 驗證用戶名稱格式
        function validateUsername(username) {
            const usernameRegex = /^[A-Za-z0-9]+$/;
            return usernameRegex.test(username);
        }

        // 驗證密碼格式
        function validatePassword(password) {
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;
            return passwordRegex.test(password);
        }

        // 跳轉到個人頁面
        function goToProfile(username) {
            window.location.href = `/Zyra/@${username}`;
        }

        // 顯示貼文
        function renderPosts(posts) {
            postsContainer.innerHTML = '';
            loadingPosts.classList.add('hidden');
            posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            posts.forEach(post => {
                const isOwner = currentUser && (currentUser.username === post.username || currentUser.isAdmin);
                const postElement = document.createElement('div');
                postElement.className = 'bg-white rounded-lg shadow-sm p-6 transition duration-300 post-card';
                postElement.setAttribute('data-post-id', post.id);

                let postHTML = `
                    <div class="flex items-start">
                        <div class="h-12 w-12 rounded-full overflow-hidden mr-4">
                `;

                if (post.avatar) {
                    postHTML += `<img src="${post.avatar}" class="h-full w-full object-cover" alt="${post.displayName || post.username}的頭像">`;
                } else {
                    postHTML += `<div class="bg-indigo-100 text-indigo-800 font-bold h-full w-full flex items-center justify-center">
                                    ${(post.displayName || post.username).charAt(0).toUpperCase()}
                                </div>`;
                }

                postHTML += `
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-bold text-gray-800 flex items-center user-link" onclick="goToProfile('${post.username}')">
                                        ${post.displayName || post.username}
                                        ${post.isVerified ? `
                                        <span class="verified-badge ml-1 h-4 w-4">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                            </svg>
                                        </span>` : ''}
                                    </h3>
                                    <p class="text-sm text-gray-500">@${post.username} · ${new Date(post.timestamp).toLocaleString('zh-TW')}</p>
                                </div>
                `;

                if (isOwner) {
                    postHTML += `
                        <button class="delete-post-btn text-gray-400 hover:text-red-500 transition" data-post-id="${post.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    `;
                }

                postHTML += `
                            </div>
                            <div class="mt-2">
                                <p class="text-gray-800 whitespace-pre-wrap">${post.content}</p>
                            </div>
                            <div class="mt-6 border-t pt-4">
                                <h5 class="font-bold text-gray-700 mb-2">留言 (${post.comments ? post.comments.length : 0})</h5>
                                <div class="space-y-3 mb-4 comments-container-${post.id}">
                `;

                if (post.comments) {
                    post.comments.forEach((comment, index) => {
                        postHTML += `
                            <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-start">
                                <div class="flex items-center">
                                    <div class="h-6 w-6 rounded-full overflow-hidden">
                        `;
                        if (comment.avatar) {
                            postHTML += `<img src="${comment.avatar}" class="h-full w-full object-cover" alt="${comment.displayName || comment.username}的頭像">`;
                        } else {
                            postHTML += `<div class="bg-indigo-100 text-indigo-800 font-bold h-full w-full flex items-center justify-center text-xs">
                                            ${(comment.displayName || comment.username).charAt(0).toUpperCase()}
                                        </div>`;
                        }
                        postHTML += `
                                    </div>
                                    <div class="ml-2">
                                        <span class="font-medium text-gray-800 user-link" onclick="goToProfile('${comment.username}')">${comment.displayName || comment.username}</span>
                                        <span class="text-xs text-gray-500 ml-2">@${comment.username}</span>
                                        <span class="text-xs text-gray-500 ml-2">${new Date(comment.timestamp).toLocaleString('zh-TW')}</span>
                                        <p class="text-gray-700 mt-1 text-sm">${comment.content}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                        `;
                        if (isOwner) {
                            postHTML += `
                                <button class="delete-comment-btn text-gray-400 hover:text-red-500 transition" data-post-id="${post.id}" data-comment-index="${index}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            `;
                        }
                        if (currentUser && currentUser.isAdmin && comment.username !== currentUser.username) {
                            postHTML += `
                                <button class="ban-user-btn text-gray-400 hover:text-red-500 transition" data-username="${comment.username}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636A9 9 0 015.636 18.364m12.728-12.728A9 9 0 015.636 18.364m12.728-12.728L5.636 18.364" />
                                    </svg>
                                </button>
                            `;
                        }
                        postHTML += `
                                </div>
                            </div>
                        `;
                    });
                }

                postHTML += `
                        </div>
                        <div class="flex">
                            <input type="text" class="comment-input flex-grow border border-gray-300 rounded-l-lg p-2 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500" placeholder="添加留言...">
                            <button class="add-comment-btn bg-indigo-600 text-white px-4 py-2 rounded-r-lg hover:bg-indigo-700 transition" data-post-id="${post.id}">發送</button>
                        </div>
                    </div>
                `;

                postElement.innerHTML = postHTML;
                postsContainer.appendChild(postElement);
            });

            // 添加留言按鈕事件
            document.querySelectorAll('.add-comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!currentUser) {
                        alert('請先登入才能留言');
                        return;
                    }
                    if (currentUser.isBanned) {
                        alert('您的帳號已被停權，無法留言');
                        return;
                    }
                    const postId = this.getAttribute('data-post-id');
                    const commentInput = this.previousElementSibling;
                    const content = commentInput.value.trim();
                    if (!content) {
                        alert('請輸入留言內容');
                        return;
                    }
                    socket.emit('addComment', { postId, username: currentUser.username, content });
                    commentInput.value = '';
                });
            });

            // 添加刪除貼文按鈕事件
            document.querySelectorAll('.delete-post-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    showDeleteConfirmDialog(postId, 'post');
                });
            });

            // 添加刪除留言按鈕事件
            document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const commentIndex = this.getAttribute('data-comment-index');
                    showDeleteConfirmDialog(postId, 'comment', commentIndex);
                });
            });

            // 添加禁制用戶按鈕事件
            document.querySelectorAll('.ban-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    showAdminPanel(username);
                });
            });
        }

        // 顯示刪除確認對話框
        function showDeleteConfirmDialog(id, type, commentIndex = null) {
            currentDeletePostId = type === 'post' ? id : null;
            currentDeleteComment = type === 'comment' ? { postId: id, commentIndex } : null;
            deleteConfirmTitle.textContent = type === 'post' ? '確定要刪除這篇貼文嗎？' : '確定要刪除這則留言嗎？';
            deleteConfirmDialog.classList.remove('hidden');
        }

        // 隱藏刪除確認對話框
        function hideDeleteConfirmDialog() {
            deleteConfirmDialog.classList.add('hidden');
            currentDeletePostId = null;
            currentDeleteComment = null;
        }

        // 顯示管理員面板
        function showAdminPanel(username) {
            banUsernameInput.value = username;
            banDaysInput.value = '';
            adminPanelModal.classList.remove('hidden');
        }

        // 更新 UI 狀態
        function updateUIState() {
            if (currentUser) {
                postSection.classList.remove('hidden');
                navButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                usernameDisplay.textContent = currentUser.displayName || currentUser.username;
                if (currentUser.avatar) {
                    navAvatarText.classList.add('hidden');
                    navAvatarImg.src = currentUser.avatar;
                    navAvatarImg.classList.remove('hidden');
                } else {
                    navAvatarText.textContent = (currentUser.displayName || currentUser.username).charAt(0).toUpperCase();
                    navAvatarText.classList.remove('hidden');
                    navAvatarImg.classList.add('hidden');
                }
                if (currentUser.isAdmin) {
                    adminPanelBtn.classList.remove('hidden');
                } else {
                    adminPanelBtn.classList.add('hidden');
                }
            } else {
                postSection.classList.add('hidden');
                navButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
        }

        // 顯示個人資料
        function showProfileModal() {
            if (currentUser) {
                document.getElementById('update-displayname').value = currentUser.displayName || currentUser.username;
                document.getElementById('update-username').value = currentUser.username;
                document.getElementById('update-about').value = currentUser.about || '';
                document.getElementById('update-email').value = currentUser.email || '';
                profileModal.classList.remove('hidden');
                settingsDropdown.classList.remove('active');
            }
        }

        // 檢查並驗證儲存的 token
        function checkStoredToken() {
            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');
            if (username && password) {
                socket.emit('verifyToken', { username, password });
            }
        }

        // 事件監聽器
        document.addEventListener('DOMContentLoaded', () => {
            checkStoredToken();
            socket.emit('getPosts');

            postBtn.addEventListener('click', () => {
                if (!currentUser) {
                    alert('請先登入才能發文');
                    return;
                }
                if (currentUser.isBanned) {
                    alert('您的帳號已被停權，無法發文');
                    return;
                }
                const content = postContent.value.trim();
                if (!content) {
                    alert('請輸入貼文內容');
                    return;
                }
                socket.emit('addPost', { username: currentUser.username, content });
                postContent.value = '';
            });

            document.getElementById('login-nav-btn').addEventListener('click', () => {
                loginModal.classList.remove('hidden');
            });

            document.getElementById('register-nav-btn').addEventListener('click', () => {
                registerModal.classList.remove('hidden');
            });

            document.getElementById('login-btn').addEventListener('click', () => {
                const identifier = document.getElementById('login-identifier').value.trim();
                const password = document.getElementById('login-password').value;
                if (!identifier || !password) {
                    alert('請填寫所有欄位');
                    return;
                }
                socket.emit('login', { identifier, password });
            });

            document.getElementById('register-btn').addEventListener('click', () => {
                const displayName = document.getElementById('register-displayname').value.trim();
                const username = document.getElementById('register-username').value.trim();
                const about = document.getElementById('register-about').value.trim();
                const password = document.getElementById('register-password').value;
                if (!username || !password) {
                    alert('請填寫所有必填欄位');
                    return;
                }
                if (!validateUsername(username)) {
                    usernameError.classList.remove('hidden');
                    return;
                }
                if (!validatePassword(password)) {
                    passwordError.classList.remove('hidden');
                    return;
                }
                usernameError.classList.add('hidden');
                passwordError.classList.add('hidden');
                socket.emit('register', { username, displayName, about, password });
            });

            document.getElementById('to-register-btn').addEventListener('click', () => {
                loginModal.classList.add('hidden');
                registerModal.classList.remove('hidden');
            });

            document.getElementById('to-login-btn').addEventListener('click', () => {
                registerModal.classList.add('hidden');
                loginModal.classList.remove('hidden');
            });

            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').classList.add('hidden');
                    passwordError.classList.add('hidden');
                    usernameError.classList.add('hidden');
                    updateUsernameError.classList.add('hidden');
                });
            });

            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function() {
                    this.closest('.modal').classList.add('hidden');
                    passwordError.classList.add('hidden');
                    usernameError.classList.add('hidden');
                    updateUsernameError.classList.add('hidden');
                });
            });

            settingsBtn.addEventListener('click', () => {
                settingsDropdown.classList.toggle('active');
            });

            profileBtn.addEventListener('click', showProfileModal);

            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('username');
                localStorage.removeItem('password');
                currentUser = null;
                settingsDropdown.classList.remove('active');
                updateUIState();
                socket.emit('getPosts');
            });

            adminPanelBtn.addEventListener('click', () => {
                showAdminPanel('');
                settingsDropdown.classList.remove('active');
            });

            document.getElementById('update-profile-btn').addEventListener('click', () => {
                const newDisplayName = document.getElementById('update-displayname').value.trim();
                const newUsername = document.getElementById('update-username').value.trim();
                const newAbout = document.getElementById('update-about').value.trim();
                const newEmail = document.getElementById('update-email').value.trim();
                if (!newUsername) {
                    alert('請填寫使用者名稱');
                    return;
                }
                if (!validateUsername(newUsername)) {
                    updateUsernameError.classList.remove('hidden');
                    return;
                }
                updateUsernameError.classList.add('hidden');
                socket.emit('updateProfile', { username: currentUser.username, newUsername, newDisplayName, newEmail, newAbout });
            });

            banUserBtn.addEventListener('click', () => {
                const username = banUsernameInput.value.trim();
                const banDays = parseInt(banDaysInput.value);
                if (!username || !banDays || banDays < 1) {
                    alert('請填寫有效的用戶名稱和禁制天數');
                    return;
                }
                socket.emit('banUser', { adminUsername: currentUser.username, targetUsername: username, banDays });
            });

            confirmDeleteBtn.addEventListener('click', () => {
                if (currentDeletePostId) {
                    socket.emit('deletePost', { postId: currentDeletePostId, username: currentUser.username });
                } else if (currentDeleteComment) {
                    socket.emit('deleteComment', { postId: currentDeleteComment.postId, commentIndex: currentDeleteComment.commentIndex, username: currentUser.username });
                }
            });

            cancelDeleteBtn.addEventListener('click', hideDeleteConfirmDialog);
        });

        // Socket.IO 事件監聽
        socket.on('connect', () => {
            checkStoredToken();
        });

        socket.on('getPostsResponse', (data) => {
            if (data.success) {
                renderPosts(data.posts);
            } else {
                alert(data.message);
            }
        });

        socket.on('addPostResponse', (data) => {
            if (data.success) {
                socket.emit('getPosts');
            } else {
                alert(data.message);
            }
        });

        socket.on('verifyTokenResponse', (data) => {
            if (data.success) {
                currentUser = data.user;
                updateUIState();
            } else {
                localStorage.removeItem('username');
                localStorage.removeItem('password');
                updateUIState();
            }
        });

        socket.on('loginResponse', (data) => {
            if (data.success) {
                currentUser = data.user;
                localStorage.setItem('username', currentUser.username);
                localStorage.setItem('password', currentUser.password);
                loginModal.classList.add('hidden');
                updateUIState();
                socket.emit('getPosts');
            } else {
                alert(data.message);
            }
        });

        socket.on('registerResponse', (data) => {
            if (data.success) {
                currentUser = data.user;
                localStorage.setItem('username', currentUser.username);
                localStorage.setItem('password', currentUser.password);
                registerModal.classList.add('hidden');
                updateUIState();
                socket.emit('getPosts');
                alert('註冊成功！');
            } else {
                alert(data.message);
            }
        });

        socket.on('updateProfileResponse', (data) => {
            if (data.success) {
                localStorage.setItem('username', data.user.username);
                currentUser = data.user;
                updateUIState();
                profileModal.classList.add('hidden');
                socket.emit('getPosts');
                alert('個人資料已更新！');
            } else {
                alert(data.message);
            }
        });

        socket.on('deletePostResponse', (data) => {
            if (data.success) {
                hideDeleteConfirmDialog();
                socket.emit('getPosts');
                alert('貼文已成功刪除！');
            } else {
                alert(data.message);
            }
        });

        socket.on('deleteCommentResponse', (data) => {
            if (data.success) {
                hideDeleteConfirmDialog();
                socket.emit('getPosts');
                alert('留言已成功刪除！');
            } else {
                alert(data.message);
            }
        });

        socket.on('addCommentResponse', (data) => {
            if (data.success) {
                socket.emit('getPosts');
            } else {
                alert(data.message);
            }
        });

        socket.on('banUserResponse', (data) => {
            if (data.success) {
                adminPanelModal.classList.add('hidden');
                alert(data.message);
            } else {
                alert(data.message);
            }
        });
    </script>
</body>
</html>
